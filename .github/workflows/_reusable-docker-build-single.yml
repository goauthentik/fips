---
# Re-usable workflow for a single-architecture build
name: Reusable - Single-arch Container build

on:
  workflow_call:
    inputs:
      target_name:
        required: true
        type: string
      registry_ghcr:
        default: true
        type: boolean
      image_suffix:
        default: ""
        type: string
      variables:
        default: ""
        type: string
      image_arch:
        required: true
        type: string
      runs-on:
        required: true
        type: string
      extra_args:
        type: string
        description: Extra args to `docker buildx` command
        default: "--push"
    outputs:
      image-digest:
        value: ${{ jobs.build.outputs.image-digest }}

jobs:
  build:
    name: Build ${{ inputs.image_arch }}
    runs-on: ${{ inputs.runs-on }}
    outputs:
      image-digest: ${{ steps.digest.outputs.digest }}
    permissions:
      # Needed to upload container images to ghcr.io
      packages: write
      # Needed for attestation
      id-token: write
      attestations: write
      # Needed for checkout
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # actions/checkout@v5
      - uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # docker/setup-qemu-action@v3.6.0
      - uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # docker/setup-buildx-action@v3
      - if: ${{ inputs.registry_ghcr }}
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: crazy-max/ghaction-github-runtime@3cb05d89e1f492524af3d41a1c98c83bc3025124 # crazy-max/ghaction-github-runtime@v3
      - id: build
        run: |
          set -xe
          docker buildx create \
            --use \
            --platform=${{ inputs.image_arch }} \
            --name multi-platform-builder \
            --driver-opt env.BUILDKIT_STEP_LOG_MAX_SIZE=50000000
          docker buildx inspect --bootstrap
          docker buildx install
          cache_scope="${{ inputs.target_name }}-${{ inputs.image_arch }}-${{ inputs.variables }}"
          run_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}/attempts/${GITHUB_RUN_ATTEMPT}"
          make \
            DOCKER_BUILDX_FLAGS="
              --platform ${{ inputs.image_arch }} \
              ${{ inputs.extra_args }} \
              --attest type=provenance,builder-id=${run_url} \
              --attest type=sbom,disabled=false \
              --cache-from type=gha,ghtoken=${{ secrets.GITHUB_TOKEN }},scope=${cache_scope} \
              --cache-to type=gha,mode=max,ghtoken=${{ secrets.GITHUB_TOKEN }},scope=${cache_scope}" \
            IMAGE_SUFFIX="${{ inputs.image_suffix }}" \
            ARCH="${{ inputs.image_arch }}" \
            ${{ inputs.variables }} \
            ${{ inputs.target_name }}
      - id: digest
        env:
          image: ${{ steps.build.outputs.full }}
        run: |
          docker pull $image
          docker inspect $image
          echo "digest=$(docker inspect $image -f '{{ index .RepoDigests 0 }}')" >> ${GITHUB_OUTPUT}
      - uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # actions/attest-build-provenance@v3
        with:
          subject-name: ${{ steps.build.outputs.image }}
          subject-digest: sha256:${{ steps.digest.outputs.digest }}
          push-to-registry: true
