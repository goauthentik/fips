---
# Re-usable workflow for a multi-architecture build
name: Reusable - Multi-arch container build

on:
  workflow_call:
    inputs:
      target_name:
        required: true
        type: string
      registry_ghcr:
        default: true
        type: boolean
      image_suffix:
        default: ""
        type: string
      variables:
        default: ""
        type: string
    outputs: {}

jobs:
  build-server-amd64:
    uses: ./.github/workflows/_reusable-docker-build-single.yml
    secrets: inherit
    with:
      target_name: ${{ inputs.target_name }}
      image_suffix: ${{ inputs.image_suffix }}
      image_arch: amd64
      runs-on: ubuntu-24.04
      registry_ghcr: ${{ inputs.registry_ghcr }}
  build-server-arm64:
    uses: ./.github/workflows/_reusable-docker-build-single.yml
    secrets: inherit
    with:
      target_name: ${{ inputs.target_name }}
      image_suffix: ${{ inputs.image_suffix }}
      image_arch: arm64
      runs-on: ubuntu-24.04-arm
      registry_ghcr: ${{ inputs.registry_ghcr }}
  merge-server:
    runs-on: ubuntu-latest
    needs:
      - build-server-amd64
      - build-server-arm64
    steps:
      - uses: actions/checkout@v5
      - name: Login to GitHub Container Registry
        if: ${{ inputs.registry_ghcr }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - id: name
        run: |
          echo tag=$(make ${{ inputs.target_name }}-name) >> $GITHUB_OUTPUT
      - uses: int128/docker-manifest-create-action@v2
        id: build
        with:
          tags: ${{ steps.name.outputs.tag }}
          sources: |
            ${{ needs.build-server-amd64.outputs.image-digest }}
            ${{ needs.build-server-arm64.outputs.image-digest }}
      # - uses: actions/attest-build-provenance@v3
      #   id: attest
      #   with:
      #     subject-name: ${{ inputs.output_name }}
      #     subject-digest: ${{ steps.build.outputs.digest }}
      #     push-to-registry: true
